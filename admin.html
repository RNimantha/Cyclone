<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cyclone Relief Fund</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-label {
            min-width: 400px;
            max-width: 800px;
            font-size: 0.8rem;
            color: #666;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            white-space: normal;
            line-height: 1.4;
        }

        .chart-visual {
            flex: 1;
            height: 30px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 15px;
            border: 1px solid #ddd;
            position: relative;
        }

        .chart-fill {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 50px;
        }

        .chart-value {
            min-width: 80px;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .photo-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .photo-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        .photo-card-content {
            padding: 15px;
        }

        .photo-card-caption {
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 500;
        }

        .photo-card-actions {
            display: flex;
            gap: 10px;
        }

        .photo-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .photo-btn-delete {
            background: #e74c3c;
            color: white;
        }

        .photo-btn-delete:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Dashboard</h1>
            <a href="/" class="logout-btn" onclick="logout()">Logout</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Visits</h3>
                <div class="value" id="totalVisits">0</div>
            </div>
            <div class="stat-card">
                <h3>Unique Visitors</h3>
                <div class="value" id="uniqueVisitors">0</div>
            </div>
            <div class="stat-card">
                <h3>PDF Downloads</h3>
                <div class="value" id="pdfDownloads">0</div>
            </div>
            <div class="stat-card">
                <h3>Sort Actions</h3>
                <div class="value" id="sortActions">0</div>
            </div>
            <div class="stat-card">
                <h3>Login Page Visits</h3>
                <div class="value" id="loginPageVisits">0</div>
            </div>
            <div class="stat-card">
                <h3>Failed Login Attempts</h3>
                <div class="value" id="failedLogins">0</div>
            </div>
        </div>

        <div class="section">
            <h2>Recent Visits</h2>
            <button class="refresh-btn" onclick="loadAdminData()">Refresh Data</button>
            <div id="visitsTable">
                <div class="no-data">Loading visit data...</div>
            </div>
        </div>

        <div class="section">
            <h2>Login Attempts</h2>
            <div id="loginAttemptsTable">
                <div class="no-data">Loading login attempt data...</div>
            </div>
        </div>

        <div class="section">
            <h2>Event Log</h2>
            <div id="eventsTable">
                <div class="no-data">Loading event data...</div>
            </div>
        </div>

        <div class="section">
            <h2>User Agent Statistics</h2>
            <div id="userAgentChart" style="margin-top: 20px;">
                <div class="no-data">Loading user agent data...</div>
            </div>
        </div>

        <div class="section">
            <h2>Photo Gallery Management</h2>
            <button class="refresh-btn" onclick="loadPhotos()">Refresh Photos</button>
            
            <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Add New Photo</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 4px;">
                    <strong style="color: #2c3e50;">Choose upload method:</strong>
                    <div style="margin-top: 10px; display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="uploadMethod" value="file" checked onchange="toggleUploadMethod()">
                            <span>Upload from computer</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="uploadMethod" value="url" onchange="toggleUploadMethod()">
                            <span>Use URL (Google Drive or Direct Link)</span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div id="fileUploadSection">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Select Photos from Computer (Multiple):</label>
                        <input type="file" id="photoFile" accept="image/*" multiple style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; background: white;">
                        <small style="color: #666; display: block; margin-top: 5px;">Supported formats: JPG, PNG, GIF, WebP (Max 5MB per image, recommended)</small>
                        <div id="photoPreview" style="margin-top: 15px; display: none; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                        </div>
                    </div>
                    
                    <div id="urlUploadSection" style="display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Photo URL (Google Drive or Direct Link):</label>
                        <input type="text" id="photoUrl" placeholder="https://drive.google.com/..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Caption (Optional):</label>
                        <input type="text" id="photoCaption" placeholder="Photo description..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                    </div>
                    <button onclick="addPhoto()" style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1rem;">Add Photo</button>
                    <div id="uploadStatus" style="margin-top: 10px; display: none;"></div>
                </div>
            </div>

            <div id="photosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                <div class="no-data">Loading photos...</div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
            if (!isAuthenticated) {
                window.location.href = '/admin/login';
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            window.location.href = '/admin/login';
        }

        async function loadAdminData() {
            // Try to fetch from Supabase API first, fallback to localStorage
            let visits = [];
            let events = [];
            let loginVisits = [];
            let loginAttempts = [];
            
            try {
                const response = await fetch('/api/analytics');
                if (response.ok) {
                    const data = await response.json();
                    visits = data.visits || [];
                    events = data.events || [];
                    loginVisits = data.loginVisits || [];
                    loginAttempts = data.loginAttempts || [];
                } else {
                    // Fallback to localStorage if API fails
                    throw new Error('API failed');
                }
            } catch (error) {
                console.warn('Failed to fetch from Supabase, using localStorage:', error);
                // Fallback to localStorage
                visits = JSON.parse(localStorage.getItem('visits') || '[]');
                events = JSON.parse(localStorage.getItem('events') || '[]');
                loginVisits = JSON.parse(localStorage.getItem('loginVisits') || '[]');
                loginAttempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
            }
            
            // Calculate statistics
            const uniqueVisitors = new Set(visits.map(v => v.visitorId)).size;
            const pdfDownloads = events.filter(e => e.type === 'download_pdf').length;
            const sortActions = events.filter(e => e.type === 'sort_donations').length;
            const failedLogins = loginAttempts.filter(a => !a.success).length;
            
            // Update stats
            document.getElementById('totalVisits').textContent = visits.length;
            document.getElementById('uniqueVisitors').textContent = uniqueVisitors;
            document.getElementById('pdfDownloads').textContent = pdfDownloads;
            document.getElementById('sortActions').textContent = sortActions;
            document.getElementById('loginPageVisits').textContent = loginVisits.length;
            document.getElementById('failedLogins').textContent = failedLogins;
            
            // Display recent visits
            const visitsTable = document.getElementById('visitsTable');
            if (visits.length === 0) {
                visitsTable.innerHTML = '<div class="no-data">No visit data available</div>';
            } else {
                const recentVisits = visits.slice(-20).reverse(); // Last 20 visits, newest first
                visitsTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>User Agent</th>
                                <th>Referrer</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentVisits.map(visit => `
                                <tr>
                                    <td>${new Date(visit.timestamp).toLocaleString()}</td>
                                    <td>${visit.userAgent ? visit.userAgent.substring(0, 50) + '...' : 'N/A'}</td>
                                    <td>${visit.referrer || 'Direct'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Display login attempts
            const loginAttemptsTable = document.getElementById('loginAttemptsTable');
            if (loginAttempts.length === 0) {
                loginAttemptsTable.innerHTML = '<div class="no-data">No login attempt data available</div>';
            } else {
                const recentAttempts = loginAttempts.slice(-30).reverse(); // Last 30 attempts
                loginAttemptsTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Password Length</th>
                                <th>User Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentAttempts.map(attempt => `
                                <tr style="background: ${attempt.success ? '#d4edda' : '#f8d7da'};">
                                    <td>${new Date(attempt.timestamp).toLocaleString()}</td>
                                    <td><strong>${attempt.success ? '✓ Success' : '✗ Failed'}</strong></td>
                                    <td>${attempt.attemptedPasswordLength}</td>
                                    <td>${attempt.userAgent ? attempt.userAgent.substring(0, 50) + '...' : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Display events
            const eventsTable = document.getElementById('eventsTable');
            if (events.length === 0) {
                eventsTable.innerHTML = '<div class="no-data">No event data available</div>';
            } else {
                const recentEvents = events.slice(-30).reverse(); // Last 30 events
                eventsTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Event Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentEvents.map(event => `
                                <tr>
                                    <td>${new Date(event.timestamp).toLocaleString()}</td>
                                    <td>${event.type}</td>
                                    <td>${event.label || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // Display user agent chart
            displayUserAgentChart(visits);
        }

        // Display User Agent Chart
        function displayUserAgentChart(visits) {
            const chartContainer = document.getElementById('userAgentChart');
            if (!chartContainer) return;

            if (visits.length === 0) {
                chartContainer.innerHTML = '<div class="no-data">No user agent data available</div>';
                return;
            }

            // Group by exact user agent string and count them
            const userAgentCounts = {};
            visits.forEach(visit => {
                const userAgent = visit.userAgent || 'Unknown';
                
                if (!userAgentCounts[userAgent]) {
                    userAgentCounts[userAgent] = 0;
                }
                userAgentCounts[userAgent]++;
            });

            // Sort by count (descending) and take top 15
            const sortedAgents = Object.entries(userAgentCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            if (sortedAgents.length === 0) {
                chartContainer.innerHTML = '<div class="no-data">No user agent data available</div>';
                return;
            }

            const maxCount = Math.max(...sortedAgents.map(([_, count]) => count));

            chartContainer.innerHTML = `
                <div class="chart-container">
                    ${sortedAgents.map(([agent, count]) => {
                        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-label">${agent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                <div class="chart-visual">
                                    <div class="chart-fill" style="width: ${percentage}%;">${count}</div>
                                </div>
                                <div class="chart-value">${count.toLocaleString()}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Photo Gallery Management
        async function loadPhotos() {
            const photosGrid = document.getElementById('photosGrid');
            if (!photosGrid) return;

            try {
                const response = await fetch('/api/photos');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to fetch photos' }));
                    throw new Error(errorData.error || `Failed to fetch photos (${response.status})`);
                }
                
                const data = await response.json();
                const photos = data.photos || [];

                if (photos.length === 0) {
                    photosGrid.innerHTML = '<div class="no-data">No photos added yet. Add your first photo above!</div>';
                    return;
                }

                photosGrid.innerHTML = photos.map(photo => `
                    <div class="photo-card">
                        <img src="${escapeHtml(photo.url)}" alt="${escapeHtml(photo.caption || 'Gallery photo')}" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'250\'%3E%3Crect fill=\'%23ddd\' width=\'300\' height=\'250\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                        <div class="photo-card-content">
                            ${photo.caption ? `<div class="photo-card-caption">${escapeHtml(photo.caption)}</div>` : ''}
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                                Added: ${new Date(photo.created_at).toLocaleDateString()}
                            </div>
                            <div class="photo-card-actions">
                                <button class="photo-btn photo-btn-delete" onclick="deletePhoto(${photo.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading photos:', error);
                photosGrid.innerHTML = '<div class="no-data">Error loading photos. Please try again.</div>';
            }
        }

        function toggleUploadMethod() {
            const fileSection = document.getElementById('fileUploadSection');
            const urlSection = document.getElementById('urlUploadSection');
            const fileRadio = document.querySelector('input[name="uploadMethod"][value="file"]');
            
            if (fileRadio && fileRadio.checked) {
                fileSection.style.display = 'block';
                urlSection.style.display = 'none';
            } else {
                fileSection.style.display = 'none';
                urlSection.style.display = 'block';
            }
        }

        // Preview images when files are selected
        function initPhotoPreview() {
            const fileInput = document.getElementById('photoFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files || []);
                    const preview = document.getElementById('photoPreview');
                    if (!preview) return;

                    if (files.length === 0) {
                        preview.style.display = 'none';
                        return;
                    }

                    preview.style.display = 'grid';
                    preview.innerHTML = '';

                    files.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = `Preview ${index + 1}`;
                            img.style.cssText = 'max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #ddd; object-fit: cover;';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }
        }

        // Compress image function - more aggressive compression
        function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.75) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        // Create canvas and compress
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to blob with compression
                        canvas.toBlob(
                            (blob) => {
                                if (!blob) {
                                    reject(new Error('Compression failed'));
                                    return;
                                }
                                // Convert blob to data URL
                                const reader2 = new FileReader();
                                reader2.onload = () => resolve(reader2.result);
                                reader2.onerror = () => reject(new Error('Failed to convert compressed image'));
                                reader2.readAsDataURL(blob);
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function addPhoto() {
            const captionInput = document.getElementById('photoCaption');
            const fileInput = document.getElementById('photoFile');
            const urlInput = document.getElementById('photoUrl');
            const uploadStatus = document.getElementById('uploadStatus');
            const fileRadio = document.querySelector('input[name="uploadMethod"][value="file"]');

            if (!captionInput) return;

            const caption = captionInput.value.trim();
            let photoUrls = [];

            // Check which method is selected
            if (fileRadio && fileRadio.checked) {
                // File upload method - handle multiple files
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    alert('Please select at least one photo file');
                    return;
                }

                const files = Array.from(fileInput.files);
                
                // Limit to 5 files at a time to avoid payload size issues
                if (files.length > 5) {
                    alert('Please select maximum 5 photos at a time. Upload in batches if you have more.');
                    return;
                }
                
                // Check file sizes (10MB limit before compression)
                for (const file of files) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File "${file.name}" is too large (must be less than 10MB). Please compress the image or use a URL instead.`);
                        return;
                    }
                }

                // Show upload status
                if (uploadStatus) {
                    uploadStatus.style.display = 'block';
                    uploadStatus.style.color = '#666';
                    uploadStatus.textContent = `Compressing ${files.length} image(s)...`;
                }

                // Compress and convert all files to base64 data URLs
                try {
                    photoUrls = await Promise.all(
                        files.map(async (file, index) => {
                            if (uploadStatus) {
                                uploadStatus.textContent = `Compressing image ${index + 1} of ${files.length}...`;
                            }
                            return await compressImage(file);
                        })
                    );
                } catch (error) {
                    if (uploadStatus) {
                        uploadStatus.style.display = 'none';
                    }
                    alert('Error processing file(s): ' + error.message);
                    return;
                }
            } else {
                // URL method - single URL
                if (!urlInput) return;
                const url = urlInput.value.trim();
                if (!url) {
                    alert('Please enter a photo URL');
                    return;
                }
                photoUrls = [url];
            }

            try {
                if (uploadStatus) {
                    uploadStatus.style.color = '#666';
                    uploadStatus.textContent = `Uploading ${photoUrls.length} photo(s)...`;
                }

                // Upload photos one at a time to avoid payload size limits
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < photoUrls.length; i++) {
                    if (uploadStatus) {
                        uploadStatus.textContent = `Uploading photo ${i + 1} of ${photoUrls.length}...`;
                    }
                    
                    try {
                        const response = await fetch('/api/photos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                url: photoUrls[i],
                                caption: caption || null,
                                display_order: 0,
                            }),
                        });

                        if (!response.ok) {
                            const text = await response.text();
                            let errorMsg;
                            try {
                                const error = JSON.parse(text);
                                errorMsg = error.error || 'Failed to add photo';
                            } catch (e) {
                                errorMsg = text || 'Failed to add photo';
                            }
                            throw new Error(errorMsg);
                        }
                        
                        await response.json();
                        successCount++;
                    } catch (error) {
                        console.error(`Error uploading photo ${i + 1}:`, error);
                        errorCount++;
                        // Continue with next photo even if one fails
                    }
                }

                // Clear inputs
                if (fileInput) {
                    fileInput.value = '';
                    const preview = document.getElementById('photoPreview');
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                }
                if (urlInput) urlInput.value = '';
                captionInput.value = '';

                if (uploadStatus) {
                    if (errorCount === 0) {
                        uploadStatus.style.color = '#27ae60';
                        uploadStatus.textContent = `${successCount} photo(s) added successfully!`;
                    } else {
                        uploadStatus.style.color = '#f39c12';
                        uploadStatus.textContent = `${successCount} photo(s) added, ${errorCount} failed.`;
                    }
                    setTimeout(() => {
                        uploadStatus.style.display = 'none';
                    }, 5000);
                }

                // Reload photos
                await loadPhotos();

                if (!uploadStatus) {
                    if (errorCount === 0) {
                        alert(`${successCount} photo(s) added successfully!`);
                    } else {
                        alert(`${successCount} photo(s) added successfully, ${errorCount} failed.`);
                    }
                }
            } catch (error) {
                console.error('Error adding photo(s):', error);
                if (uploadStatus) {
                    uploadStatus.style.display = 'block';
                    uploadStatus.style.color = '#e74c3c';
                    uploadStatus.textContent = 'Error: ' + error.message;
                } else {
                    alert('Error adding photo(s): ' + error.message);
                }
            }
        }

        async function deletePhoto(id) {
            if (!confirm('Are you sure you want to delete this photo?')) {
                return;
            }

            try {
                const response = await fetch(`/api/photos?id=${id}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error('Failed to delete photo');
                }

                // Reload photos
                await loadPhotos();

                alert('Photo deleted successfully!');
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Error deleting photo: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check auth on page load
        checkAuth();
        loadAdminData();
        loadPhotos();
        initPhotoPreview();
        
        // Auto-refresh every 30 seconds
        setInterval(loadAdminData, 30000);
    </script>
</body>
</html>

